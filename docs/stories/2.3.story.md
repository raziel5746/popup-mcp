# Story 2.3: Implement Accurate Popup Routing

## Status
Approved

## Story
**As an** AI assistant,  
**I want** popups to route to the correct VS Code instance based on included workspace path,  
**so that** interactions target the intended project.

## Acceptance Criteria
1: Requires AI to include workspace path in popup data.  
2: Routes request to matching instance using registered paths.  
3: Falls back gracefully (e.g., error message) if no match found.  
4: End-to-end testing with multiple instances verifies routing accuracy.

## Tasks / Subtasks
- [ ] Validate workspace path in requests (AC: 1) [Source: architecture/api-specification.md#request-schema]  
  - [ ] Add validation in requestHandler.ts  
- [ ] Implement routing logic (AC: 2) [Source: architecture/components.md#instance-router]  
  - [ ] Match path to registered instances  
  - [ ] Forward request to target  
- [ ] Handle no-match cases (AC: 3)  
  - [ ] Return JSON-RPC error to AI  
- [ ] Add E2E tests (AC: 4) [Source: architecture/testing-strategy.md#e2e-tests]  
  - [ ] Simulate multi-instance routing  

## Dev Notes
- **Previous Story Insights**: Use election from 2.2 and detection from 2.1.  
- **Data Models**: Require workspacePath in PopupRequest. [Source: architecture/data-models.md#popuprequest]  
- **API Specifications**: Validate in incoming JSON-RPC. [Source: architecture/api-specification.md]  
- **Component Specifications**: RouteToInstance in InstanceRouter. [Source: architecture/components.md#instance-router]  
- **File Locations**: backend/coordination.ts or router.ts. [Source: architecture/unified-project-structure.md]  
- **Testing Requirements**: E2E for routing. [Source: architecture/testing-strategy.md#e2e-tests]  
- **Technical Constraints**: Graceful fallback.  

**Project Structure Notes**: No issues.

### Testing
- Test file location: tests/e2e/.  
- Test standards: E2E.  
- Frameworks: Playwright.  
- Specific: Test routing, no-match.

## Change Log
| Date | Version | Description | Author |  
|------|---------|-------------|--------|  

## Dev Agent Record
### Agent Model Used  

### Debug Log References  

### Completion Notes List  

### File List  

## QA Results
