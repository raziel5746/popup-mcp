# Story 1.7: Implement MCP Tool for Popup Triggering and Config Export Commands

## Status
Approved

## Story
**As an** AI assistant integrated with VS Code,  
**I want** to trigger custom popups in the IDE via an MCP tool and easily configure connections using exported JSON,  
**so that** I can elicit user feedback through popups and simplify setup for HTTP/stdio transports.

## Acceptance Criteria
1: Expose an MCP tool (e.g., "triggerPopup") that allows AI clients to request popups, following MCP tool protocol (discovery via tools/list, invocation via tools/call).  
2: Implement command palette commands to copy HTTP and stdio config JSON to clipboard, with dynamic port/path resolution.  
3: Update README.md with JSON examples, usage instructions, and MCP tool documentation.  
4: Ensure tool handles errors gracefully.  
5: Add unit/integration tests for tool calls and config export.

## Tasks / Subtasks
- [ ] Define and expose MCP tool for popups (AC: 1, 4) [Source: MCP Specs - Tools Protocol]  
  - [ ] In src/backend/mcpServer.ts, add tool to tools/list response: {name: "triggerPopup", description: "Trigger a popup in VS Code for user input", inputSchema: {type: "object", properties: {title: {type: "string"}, message: {type: "string"}, options: {type: "array", items: {type: "string"}}, allowText: {type: "boolean"}}, required: ["title", "message"]}, annotations: {readOnlyHint: true, destructiveHint: false}}.  
  - [ ] Implement tools/call handler: Parse input, display popup via PopupWebview, collect response, return as {content: [{type: "text", text: JSON.stringify(response)}]} or {isError: true} on failure.  
  - [ ] Declare tools capability in initialize response: {"capabilities": {"tools": {"listChanged": false}}}.  
- [ ] Add command palette commands for config export (AC: 2) [Source: architecture/components.md#commands]  
  - [ ] Register "popupmcp.copyHttpConfig" and "popupmcp.copyStdioConfig" in src/extension.ts.  
  - [ ] For HTTP: Fetch port from settings (default 9001), generate JSON: {"mcpServers": {"popup-mcp": {"url": "http://localhost:<port>/mcp"}}}, copy to clipboard using vscode.env.clipboard.writeText.  
  - [ ] For stdio: Dynamically resolve extension path (context.extensionUri.fsPath + '/out/backend/mcpServer.js'), detect OS (process.platform), generate JSON with "command": "node", "args": ["<full-path-to-mcpServer.js>"], copy to clipboard.  
- [ ] Update README.md (AC: 3) [Source: architecture/unified-project-structure.md#docs]  
  - [ ] Add section "MCP Server Configuration" with HTTP and stdio JSON examples, notes on ports/paths, and usage in AI configs.  
  - [ ] Document "triggerPopup" tool with schema, example call (tools/call JSON), and response format.  
- [ ] Testing (AC: 5) [Source: architecture/testing-strategy.md#integration]  
  - [ ] Add tests/unit/backend/triggerPopup.test.ts: Mock tool call, verify popup invocation and response.  
  - [ ] Add tests/integration/configExport.test.ts: Verify JSON generation and clipboard copy for both transports.

## Dev Notes
- **Previous Story Insights**: Builds on 1.3-1.5 (MCP server, popup display, response handling). No overlaps confirmed. TODO: Integrate multi-instance routing after Epic 2 implementation.  
- **Data Models**: Use PopupRequest for tool input (extend with MCP schema); PopupResponse for output. [Source: architecture/data-models.md#popuprequest]  
- **API Specifications**: Follow MCP tools protocolâ€”use JSON-RPC for calls; handle errors per specs (isError: true). Use tools for IDE-specific UI. [Source: MCP Specs - Tools Message Flow]  
- **Component Specifications**: Update McpServer to handle tools/list and tools/call; integrate with PopupWebview for display. [Source: architecture/backend-architecture.md]  
- **File Locations**: src/backend/mcpServer.ts for tool logic; src/extension.ts for commands; README.md for docs. [Source: architecture/unified-project-structure.md]  
- **Testing Requirements**: Jest for unit (tool schemas); integration for end-to-end (call -> popup -> response). [Source: architecture/testing-strategy.md#backend-tests]  
- **Technical Constraints**: Ensure tool is non-destructive (annotations); require user consent via popup. Default port 9001; handle OS paths (e.g., escape backslashes on Windows). [Source: architecture/tech-stack.md]  
**Project Structure Notes**: Aligns with backend; no conflicts. For MCP details, reference official specs: tools/call expects schema-matched args; return structured content.

### Testing
- Test file location: tests/unit/backend/ and tests/integration/.  
- Test standards: Pyramid with integration focus.  
- Frameworks: Jest.  
- Specific: Test tool discovery, invocation, JSON export accuracy.

## Change Log
| Date | Version | Description | Author |  
|------|---------|-------------|--------|  

## Dev Agent Record
### Agent Model Used  
(To be filled by dev)

### Debug Log References  
(To be filled by dev)

### Completion Notes List  
(To be filled by dev)

### File List  
(To be filled by dev)

## QA Results
(To be filled after implementation)