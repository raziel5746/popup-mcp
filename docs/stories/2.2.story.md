# Story 2.2: Enable Server/Client Coordination

## Status
Approved

## Story
**As the** extension,  
**I want** to coordinate a single MCP server across multiple VS Code instances, with others acting as clients,  
**so that** there's unified handling of popup requests.

## Acceptance Criteria
1: Elects one instance as server, others as clients via coordination mechanism.  
2: Clients forward requests to the server if needed.  
3: Status bar updates to reflect server/client role.  
4: Graceful handling of server shutdown (e.g., elect new server).

## Tasks / Subtasks
- [ ] Implement election mechanism (AC: 1) [Source: architecture/components.md#instance-router]  
  - [ ] Use shared state or IPC for election on activation  
- [ ] Set up client forwarding (AC: 2)  
  - [ ] Clients send requests to server instance  
- [ ] Update status bar for roles (AC: 3) [Source: architecture/components.md#status-bar-manager]  
  - [ ] Add role indicator in tooltip/icon  
- [ ] Handle shutdown and re-election (AC: 4)  
  - [ ] Detect shutdown and trigger new election  
- [ ] Test multi-instance coordination (AC: all) [Source: architecture/testing-strategy.md#e2e-tests]  

## Dev Notes
- **Previous Story Insights**: Use path detection from 2.1 for identification.  
- **Data Models**: Use StatusState for role (server-active, client-active). [Source: architecture/data-models.md#statusstate]  
- **API Specifications**: Internal IPC for coordination.  
- **Component Specifications**: InstanceRouter for election and forwarding. [Source: architecture/components.md#instance-router]  
- **File Locations**: backend/coordination.ts. [Source: architecture/unified-project-structure.md]  
- **Testing Requirements**: E2E for coordination. [Source: architecture/testing-strategy.md#e2e-tests]  
- **Technical Constraints**: Use VS Code API for IPC if possible.  

**Project Structure Notes**: Extends backend.

### Testing
- Test file location: tests/e2e/.  
- Test standards: E2E.  
- Frameworks: Playwright.  
- Specific: Test election, forwarding, shutdown.

## Change Log
| Date | Version | Description | Author |  
|------|---------|-------------|--------|  

## Dev Agent Record
### Agent Model Used  

### Debug Log References  

### Completion Notes List  

### File List  

## QA Results
