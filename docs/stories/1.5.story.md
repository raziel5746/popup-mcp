# Story 1.5: Handle User Responses and Routing

## Status
Approved

## Story
**As an** AI assistant,  
**I want** to receive user button clicks or text responses back via MCP,  
**so that** interactions are complete and seamless.

## Acceptance Criteria
1: Captures button selection or text input and sends response via MCP.  
2: Closes the popup tab after response submission.  
3: Handles errors gracefully with user notifications.  
4: Verifies response routing in single-instance setup.

## Tasks / Subtasks
- [ ] Implement response capture in PopupWebview (AC: 1) [Source: architecture/frontend-architecture.md#component-template]  
  - [ ] Add message listener for button clicks/text submit  
  - [ ] Create PopupResponse with requestId and selectedValue  
- [ ] Integrate with MCP server for sending responses (AC: 1, 4) [Source: architecture/backend-architecture.md#traditional-server-embedded]  
  - [ ] Emit response event or call responseHandler.ts  
  - [ ] Route back to AI via original transport (HTTP/SSE or stdio)  
- [ ] Handle popup closure (AC: 2)  
  - [ ] Dispose WebviewPanel after response send  
- [ ] Add error handling (AC: 3) [Source: architecture/error-handling-strategy.md#frontend-error-handling]  
  - [ ] Show VS Code notifications for failures  
  - [ ] Log errors to output channel  
- [ ] Verify single-instance routing (AC: 4) [Source: architecture/core-workflows.md]  
  - [ ] Test end-to-end response flow in local setup  
- [ ] Write integration tests (AC: all) [Source: architecture/testing-strategy.md#integration]  
  - [ ] Test response capture, routing, closure, and error cases  

## Dev Notes
- **Previous Story Insights**: Integrate with popup display from 1.4 and server from 1.3; no prior dev notes.  
- **Data Models**: Use PopupResponse for outgoing data (requestId, selectedValue). [Source: architecture/data-models.md#popupresponse]  
- **API Specifications**: Send JSON-RPC response over MCP transport; use SSE for HTTP if async. [Source: architecture/api-specification.md#response-schema]  
- **Component Specifications**: Update PopupWebview with onDidReceiveMessage for responses; use responseHandler in backend. [Source: architecture/components.md#popup-renderer]  
- **File Locations**: Update src/components/PopupWebview.ts, src/backend/responseHandler.ts. [Source: architecture/unified-project-structure.md]  
- **Testing Requirements**: Integration tests for full flow using Jest. [Source: architecture/testing-strategy.md#integration]  
- **Technical Constraints**: Ensure graceful errors without crashing extension; follow JSON-RPC spec. [Source: architecture/tech-stack.md]  

**Project Structure Notes**: Builds on existing backend/frontend; no conflicts.

### Testing
- Test file location: tests/integration/ for response flows. [Source: architecture/testing-strategy.md#integration]  
- Test standards: Emphasize integration in pyramid. [Source: architecture/testing-strategy.md#testing-pyramid]  
- Testing frameworks and patterns: Jest for mocking transports/responses. [Source: architecture/testing-strategy.md#test-examples]  
- Any specific testing requirements for this story: Cover happy path, errors, and closure.

## Change Log
| Date | Version | Description | Author |  
|------|---------|-------------|--------|  

## Dev Agent Record
### Agent Model Used  

### Debug Log References  

### Completion Notes List  

### File List  

## QA Results
